---
title: "Flaschendrehen"
themecolor: "#ccc"
themedforecolor: "#7f7f7f"
showmeta: false
---
<app-view id="app-view" class="setup">
  <view-header>
    <h2>Setup</h2>
  </view-header>
  <div class="tab-headers">
    <button onclick="showTab('player-tab', this);return false;" class="active">Spieler</button>
    <button onclick="showTab('quest-tab', this);return false;">Fragen</button>
  </div>
  <section id="player-tab" class="show">
    <p>Zu Beginn können hier die Namen der Spieler eingetragen werden. Wenn nur zufällige Fragen angezeigt werden sollen, dann bitte leer lassen.</p>
    <div id="players"></div>
    <div class="player">
      <button id="add-player" onclick="game.addPlayer();return false;">+ Spieler hinzufügen</button>
      <button id="import-player" onclick="game.importPlayers();return false;">Spieler importieren</button>
      <button id="export-player" onclick="game.exportPlayers();return false;">Spieler exportieren</button>
    </div>
  </section>
  <section id="quest-tab">
    <p>Hier werden alle Fragen angezeigt und können bearbeitet und oder gelöscht werden; neue Fragen können auch hinzugefügt werden.</p>
    <div id="quests"></div>
    <div class="quest">
      <button id="add-quests" onclick="game.addQuest();return false;">+ Frage hinzufügen</button>
      <button id="import-quests" onclick="game.importQuests();return false;">Fragen importieren</button>
      <button id="export-quests" onclick="game.exportQuests();return false;">Fragen exportieren</button>
    </div>
  </section>
  <view-footer>
    <button id="start" onclick="game.start();return false;">Einstellungen speichern und Spiel starten</button>
  </view-footer>
</app-view>
<style>
  app-view {
    display: block;
  }
  .player,
  .quest,
  .tab-headers{
    display: flex;
    flex-flow: row nowrap;
    overflow: auto;
  }
  .player input,
  .quest input {
    margin-right: 0.5em;
  }
  .player button,
  .quest button {
    padding: 0.5em 1em;
  }
  section {
    display: none;
  }
  section.show {
    display: block;
  }
  #app-view.play section {
    width: 400px;
    max-width: 100%;
    margin: 0 auto;
    flex-flow: row nowrap;
    align-items: center;
  }
  #app-view.play section.show {
    display: flex;
  }
  #app-view.play section img {
    display: inline-block;
    width: 100%;
  }
</style>
<script type="text/javascript">
  function showTab(id, button) {
    var arr = button.parentElement.getElementsByTagName("button");
    for (item of arr) {
      if (item === button) {
        item.classList.add("active");
      }
      else {
        item.classList.remove("active");
      };
    };
    game.showSection(id);
  };
  var game = {
    addPlayer: function () {
      var value = arguments[0] || "";
      var players = document.getElementById("players");
      var div = document.createElement("div");
      var input = document.createElement("input");
      var remove = document.createElement("button");
      div.className = "player";
      input.value = value;
      input.placeholder = "Spielernamen einfügen";
      div.appendChild(input);
      remove.onclick = function(event) {
        players.removeChild(div);
        event.preventDefault();
      };
      remove.textContent = "-";
      div.appendChild(remove);
      players.appendChild(div);
      input.focus();
    },
    importPlayers: function () {
      var players = arguments[0] || "";
      if (arguments.length == 0) {
        players = prompt("Bitte füge die Spieler hier ein", '[ "Name 1 ... ", "Name 2 ... " ]');
      };
      if (players) {
        try {
          players = JSON.parse(players);
          if (players instanceof self.Array) {
            players.forEach(game.addPlayer);
          };
        }
        catch (e) { }
      };
    },
    exportPlayers: function () {
      var players = document.getElementById("players").getElementsByTagName("input");
      var arr = [];
      for (player of players) {
        if (player.value) {
          arr.push(player.value);
        };
      };
      prompt("Kopiere diese Spieler, um sie an anderer Stelle zu importieren", JSON.stringify(arr));
    },
    addQuest: function () {
      var value = arguments[0] || "";
      var quests = document.getElementById("quests");
      var div = document.createElement("div");
      var input = document.createElement("input");
      var remove = document.createElement("button");
      div.className = "quest";
      input.value = value;
      input.placeholder = "Frage einfügen";
      div.appendChild(input);
      remove.onclick = function (event) {
        quests.removeChild(div);
        event.preventDefault();
      };
      remove.textContent = "-";
      div.appendChild(remove);
      quests.appendChild(div);
      input.focus();
    },
    importQuests: function () {
      var quests = arguments[0] || "";
      if (arguments.length == 0) {
        quests = prompt("Bitte füge die Fragen hier ein", '[ "Frage 1 ... ", "Frage 2 ... " ]');
      };
      if (quests) {
        try {
          quests = JSON.parse(quests);
          if (quests instanceof self.Array) {
            quests.forEach(game.addQuest);
          };
        }
        catch (e) { }
      };
    },
    exportQuests: function () {
      var quests = document.getElementById("quests").getElementsByTagName("input");
      var arr = [];
      for (quest of quests) {
        if (quest.value) {
          arr.push(quest.value);
        };
      };
      prompt("Kopiere diese Fragen, um sie an anderer Stelle zu importieren", JSON.stringify(arr));
    },
    random: function (size) {
      return Math.round(Math.random() * size);
    },
    showSection: function (id) {
      var appView = document.getElementById("app-view");
      var sections = appView.getElementsByTagName("section");
      for (section of sections) {
        if (section.id == id) {
          section.classList.add("show");
        }
        else {
          section.classList.remove("show");
        };
      };
    },
    players: [],
    quests: [],
    start: function () {
      var players = document.getElementById("players").getElementsByTagName("input");
      var quests = document.getElementById("quests").getElementsByTagName("input");
      for (quest of quests) {
        if (quest.value) {
          game.quests.push(quest.value);
        };
      };
      var players_array = [];
      for (player of players) {
        if (player.value) {
          game.players.push({
            name: player.value,
            quests: game.quests.slice(0)
          });
          players_array.push(player.value);
        };
      };
      localStorage.setItem("SpinTheBottle.Players", JSON.stringify(players_array));
      localStorage.setItem("SpinTheBottle.Quests", JSON.stringify(game.quests));
      if (game.quests.length > 0) {
        game.createView();
      }
      else {
        alert("Bitte gib mindestens eine Frage an!");
      };
    },
    createView: function () {
      var appView = document.getElementById("app-view");
      while (appView.firstChild) {
        appView.removeChild(appView.firstChild);
      };
      appView.className = "play";
      var header = document.createElement("div");
      var h2 = document.createElement("h2");
      var section = document.createElement("section");
      var p = document.createElement("p");
      var bottleSection = document.createElement("section");
      var bottle = document.createElement("img");
      var footer = document.createElement("div");
      var button = document.createElement("button");
      header.id = "header";
      h2.id = "player";
      h2.textContent = "Spieler";
      header.appendChild(h2);
      appView.appendChild(header);
      p.id = "quest";
      p.textContent = "Um das Spiel zu beenden, einfach nur den Browser(-Tab) schließen oder zum neustarten, die Seite neuladen.";
      section.id = "questSection";
      section.className = "show";
      section.appendChild(p);
      appView.appendChild(section);
      bottle.src = "/flaschendrehen/bottle.png";
      bottle.id = "bottle";
      bottleSection.id = "bottleSection";
      bottleSection.appendChild(bottle);
      button.textContent = "Flasche drehen";
      bottle.deg = 0;
      button.onclick = function (event) {
        event.preventDefault();
        game.showSection("bottleSection");
        var index = 0;
        var timeout = 360 + game.random(360);
        var interval = setInterval(function () {
          bottle.style.transform = "rotate(" + bottle.deg + "deg)";
          if (++bottle.deg == 360) {
            bottle.deg = 0;
          };
          if (index++ > timeout) {
            clearInterval(interval);
            setTimeout(function () {
              game.showSection("questSection");
            }, 500);
          };
        });
        game.quest();
      };
      appView.appendChild(bottleSection);
      footer.appendChild(button);
      footer.id = "footer";
      appView.appendChild(footer);
    },
    quest: function () {
      var player = {
        name: "",
        quests: game.quests
      };
      var item = 0,
        length = game.players.length;
      if (game.players.length > 0) {
        for (item = 0; item < length; item++) {
          if (game.players[item].quests.length > 0) {
            break;
          };
        };
        if (item == length) {
          alert("Alle Fragen aufgebraucht");
          location.reload();
          return;
        };
        do {
          player = game.players[game.random(game.players.length - 1)];
        }
        while (player.quests.length == 0);
      };
      var questIndex = game.random(player.quests.length - 1);
      var quest = player.quests[questIndex];
      if (player.name) {
        player.quests = player.quests.slice(0, questIndex).concat(player.quests.slice(questIndex + 1));
        var h2 = document.getElementById("player");
        h2.textContent = player.name;
      };
      var p = document.getElementById("quest");
      p.textContent = quest;
    }
  };
  game.importPlayers(localStorage.getItem('SpinTheBottle.Players'));
  game.importQuests(localStorage.getItem('SpinTheBottle.Quests'));
</script>
